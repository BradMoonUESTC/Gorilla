#!/usr/bin/env python3
"""
Exploit demonstration script - specifically tests smart contract security vulnerabilities
"""

import os
import sys
from pathlib import Path
from dotenv import load_dotenv

# æ·»åŠ srcç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from main import GorillaTestSystem


def main():
    """Exploit demo"""
    
    print("ğŸ” Gorilla Smart Contract Vulnerability Exploration System")
    print("=" * 50)
    
    # Load environment variables
    load_dotenv()
    
    # Set project path
    project_path = os.path.join(os.path.dirname(__file__), 'test-project')
    
    print(f"ğŸ“ Project path: {project_path}")
    print()
    
    # Display known contract vulnerabilities
    print("ğŸš¨ Known vulnerabilities in the target contract:")
    print("  1. Reentrancy - withdraw performs external call before state update")
    print("  2. Missing access control - mint can be called by anyone")
    print("  3. Allowance mechanism flaw - transferFrom does not decrease allowance")
    print("  4. Integer overflow risk - transfer uses unchecked block")
    print()
    
    # Create test system
    system = GorillaTestSystem(project_path)
    
    # Vulnerability exploration tests
    vulnerability_tests = [
        {
            "name": "Reentrancy Attack Test",
            "description": "Test the reentrancy vulnerability in withdraw by creating a malicious contract to steal funds via reentrancy"
        },
        {
            "name": "Access Control Test", 
            "description": "Test the access control vulnerability in mint by verifying whether any user can mint tokens without restriction"
        },
        {
            "name": "Allowance Mechanism Test",
            "description": "Test allowance vulnerability in transferFrom by verifying whether the same allowance can be reused"
        }
    ]
    
    print("ğŸ¯ Starting vulnerability exploration tests:")
    print("=" * 50)
    
    for i, test in enumerate(vulnerability_tests, 1):
        print(f\"\nğŸ” Test {i}: {test['name']}\")
        print(f\"Description: {test['description']}\")
        print("-" * 30)
        
        try:
            success = system.generate_and_run_test(test['description'])
            
            if success:
                print(f\"âœ… {test['name']} - Test executed successfully\")
                
                # Show generated test file
                test_file = Path(project_path) / "test" / "GorillaTest.t.sol"
                if test_file.exists():
                    print(f\"ğŸ“„ Generated vulnerability test file: {test_file}\")
            else:
                print(f\"âŒ {test['name']} - Test execution failed\")
                
        except Exception as e:
            print(f\"âŒ {test['name']} - Error occurred: {e}\")
        
        # Ask whether to continue to the next test
        if i < len(vulnerability_tests):
            continue_test = input(f\"\nContinue to the next test? (y/n): \").strip().lower()
            if continue_test != 'y':
                break
    
    print("\n" + "=" * 50)
    print("ğŸ‰ Exploit demo completed!")
    print("ğŸ’¡ Tip: Check the generated test file to see the specific exploit code")


if __name__ == "__main__":
    main()


