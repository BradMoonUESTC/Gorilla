#!/usr/bin/env python3
"""
æ¼æ´æŒ–æ˜æ¼”ç¤ºè„šæœ¬ - ä¸“é—¨æµ‹è¯•æ™ºèƒ½åˆçº¦å®‰å…¨æ¼æ´
"""

import os
import sys
from pathlib import Path
from dotenv import load_dotenv

# æ·»åŠ srcç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from main import GorillaTestSystem


def main():
    """æ¼æ´æŒ–æ˜æ¼”ç¤º"""
    
    print("ğŸ” Gorillaæ™ºèƒ½åˆçº¦æ¼æ´æŒ–æ˜ç³»ç»Ÿ")
    print("=" * 50)
    
    # åŠ è½½ç¯å¢ƒå˜é‡
    load_dotenv()
    
    # è®¾ç½®é¡¹ç›®è·¯å¾„
    project_path = os.path.join(os.path.dirname(__file__), 'test-project')
    
    print(f"ğŸ“ é¡¹ç›®è·¯å¾„: {project_path}")
    print()
    
    # æ˜¾ç¤ºåˆçº¦æ¼æ´ä¿¡æ¯
    print("ğŸš¨ ç›®æ ‡åˆçº¦åŒ…å«çš„å·²çŸ¥æ¼æ´:")
    print("  1. é‡å…¥æ”»å‡» - withdrawå‡½æ•°åœ¨çŠ¶æ€æ›´æ–°å‰è¿›è¡Œå¤–éƒ¨è°ƒç”¨")
    print("  2. æƒé™æ§åˆ¶ç¼ºå¤± - mintå‡½æ•°ä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨")
    print("  3. allowanceæœºåˆ¶ç¼ºé™· - transferFromä¸å‡å°‘æˆæƒé¢åº¦")
    print("  4. æ•´æ•°æº¢å‡ºé£é™© - transferå‡½æ•°ä½¿ç”¨uncheckedå—")
    print()
    
    # åˆ›å»ºæµ‹è¯•ç³»ç»Ÿ
    system = GorillaTestSystem(project_path)
    
    # æ¼æ´æŒ–æ˜æµ‹è¯•
    vulnerability_tests = [
        {
            "name": "é‡å…¥æ”»å‡»æµ‹è¯•",
            "description": "æµ‹è¯•withdrawå‡½æ•°çš„é‡å…¥æ”»å‡»æ¼æ´ï¼Œåˆ›å»ºæ¶æ„åˆçº¦åˆ©ç”¨é‡å…¥æœºåˆ¶çªƒå–èµ„é‡‘"
        },
        {
            "name": "æƒé™æ§åˆ¶æµ‹è¯•", 
            "description": "æµ‹è¯•mintå‡½æ•°çš„æƒé™æ§åˆ¶æ¼æ´ï¼ŒéªŒè¯ä»»æ„ç”¨æˆ·æ˜¯å¦å¯ä»¥æ— é™åˆ¶é“¸é€ ä»£å¸"
        },
        {
            "name": "allowanceæœºåˆ¶æµ‹è¯•",
            "description": "æµ‹è¯•transferFromçš„allowanceæœºåˆ¶æ¼æ´ï¼ŒéªŒè¯æ˜¯å¦å¯ä»¥é‡å¤ä½¿ç”¨åŒä¸€ä¸ªæˆæƒé¢åº¦"
        }
    ]
    
    print("ğŸ¯ å¼€å§‹æ¼æ´æŒ–æ˜æµ‹è¯•:")
    print("=" * 50)
    
    for i, test in enumerate(vulnerability_tests, 1):
        print(f"\nğŸ” æµ‹è¯• {i}: {test['name']}")
        print(f"æè¿°: {test['description']}")
        print("-" * 30)
        
        try:
            success = system.generate_and_run_test(test['description'])
            
            if success:
                print(f"âœ… {test['name']} - æµ‹è¯•æˆåŠŸæ‰§è¡Œ")
                
                # æ˜¾ç¤ºç”Ÿæˆçš„æµ‹è¯•æ–‡ä»¶
                test_file = Path(project_path) / "test" / "GorillaTest.t.sol"
                if test_file.exists():
                    print(f"ğŸ“„ ç”Ÿæˆçš„æ¼æ´æµ‹è¯•æ–‡ä»¶: {test_file}")
            else:
                print(f"âŒ {test['name']} - æµ‹è¯•æ‰§è¡Œå¤±è´¥")
                
        except Exception as e:
            print(f"âŒ {test['name']} - å‘ç”Ÿé”™è¯¯: {e}")
        
        # è¯¢é—®æ˜¯å¦ç»§ç»­ä¸‹ä¸€ä¸ªæµ‹è¯•
        if i < len(vulnerability_tests):
            continue_test = input(f"\nç»§ç»­ä¸‹ä¸€ä¸ªæµ‹è¯•? (y/n): ").strip().lower()
            if continue_test != 'y':
                break
    
    print("\n" + "=" * 50)
    print("ğŸ‰ æ¼æ´æŒ–æ˜æ¼”ç¤ºå®Œæˆ!")
    print("ğŸ’¡ æç¤º: æŸ¥çœ‹ç”Ÿæˆçš„æµ‹è¯•æ–‡ä»¶äº†è§£å…·ä½“çš„æ¼æ´åˆ©ç”¨ä»£ç ")


if __name__ == "__main__":
    main()


